# Chrome扩展修复步骤指南

## 🚨 发现的错误

1. **URL Pattern错误**: `'*://sns-video-*.xhscdn.com/stream/*'` 不是有效的URL模式
2. **消息通道关闭错误**: 异步响应机制导致消息通道过早关闭
3. **Content Script响应问题**: 页面脚本可能在响应前被卸载

## 🔧 已修复的问题

### 1. URL Pattern修复
**原问题**:
```javascript
{ urls: ["*://sns-video-*.xhscdn.com/stream/*"] }
```

**修复后**:
```javascript
{ 
  urls: [
    "*://sns-video*.xhscdn.com/*",
    "*://*.xhscdn.com/stream/*"
  ]
}
```

### 2. 消息通道修复
- 添加了超时保护机制（30秒）
- 改进了错误信息提示
- 增加了重试机制

### 3. Script注入优化
- 多次重试注入（最多3次）
- 延长等待时间（5秒）
- 添加响应验证

## 📋 测试步骤

### 步骤1: 基础连接测试
1. 打开Chrome扩展管理页面
2. 重新加载扩展
3. 查看background页面控制台是否有错误

### 步骤2: 使用测试页面
1. 访问: `chrome-extension://[你的扩展ID]/test.html`
2. 点击"测试Ping"按钮
3. 查看是否显示成功响应

### 步骤3: 实际功能测试
1. 打开小红书网站
2. 使用扩展进行关键词搜索
3. 查看progress页面是否正常工作

## 🔍 调试方法

### 查看Background Script日志
1. 打开 `chrome://extensions/`
2. 找到你的扩展
3. 点击"背景页"或"Service Worker"
4. 查看控制台日志

### 查看Content Script日志
1. 在小红书页面按F12
2. 查看控制台日志
3. 确认content script是否正确加载

### 检查权限问题
确保manifest.json中包含必要权限：
```json
{
  "permissions": [
    "downloads",
    "storage", 
    "scripting",
    "webRequest",
    "declarativeNetRequest",
    "tabs"
  ],
  "host_permissions": [
    "*://*.xiaohongshu.com/*",
    "*://sns-img*.xhscdn.com/*",
    "*://sns-video*.xhscdn.com/*"
  ]
}
```

## ⚠️ 常见问题解决

### 问题1: "Background script not responding"
**解决方案**: 
- 重新加载扩展
- 检查background.js是否有语法错误
- 确认service worker是否启动

### 问题2: "页面脚本未响应"
**解决方案**:
- 刷新小红书页面
- 确认content script正确注入
- 检查网络连接

### 问题3: "脚本注入失败"
**解决方案**:
- 检查manifest权限配置
- 确认target页面URL匹配
- 重启Chrome浏览器

## 🚀 推荐使用方式

1. **首次使用**: 先用test.html验证连接
2. **出现问题**: 查看控制台日志定位问题
3. **功能正常**: 正常使用扩展功能

## 📝 文件更新清单

✅ `background.js` - 修复URL pattern和错误处理
✅ `content.js` - 添加ping响应和错误处理  
✅ `progress.js` - 改进连接重试机制
✅ `background-fixed.js` - 完整修复版本
✅ `test.html` - 连接测试工具

使用这些修复后，扩展应该能正常工作！ 